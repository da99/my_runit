#!/usr/bin/env zsh
#
# === {{CMD}} service-name new-dir
#
set -u -e -o pipefail

set "-x"
local +x SV_NAME="$1"; shift

cd "$1"; shift
local +x NEW_DIR="$PWD"

find . -type f -name run | xargs -I NAME chmod +x NAME

sudo sv stop $SV_NAME     || :
sudo sv stop $SV_NAME/log || :
sleep 2
sudo rm -f /var/service/$SV_NAME

sudo ln -s "$NEW_DIR" /var/service/$SV_NAME
